<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assessment Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
  <style>
    :root {
      --primary: #003366;
      --primary-light: #1a4d80;
      --primary-dark: #00264d;
      --secondary: #FFD700;
      --secondary-light: #ffe44d;
      --bg-light: #FFFFFF;
      --bg-gray: #F5F5F5;
      --text-dark: #333333;
      --text-black: #000000;
      --text-light: #FFFFFF;
      --success: #4CAF50;
      --error: #F44336;
      --warning: #FFC107;
      --info: #17A2B8;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gray);
      margin: 0;
      padding: 20px;
      color: var(--text-dark);
    }

    header {
      margin-bottom: 20px;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 5px;
    }

    .course-info {
      font-size: 0.95rem;
      color: var(--primary-light);
    }

    .search-box {
      margin: 15px 0;
    }

    .search-box input {
      padding: 10px 14px;
      width: 100%;
      max-width: 400px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 0.95rem;
      outline: none;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--bg-light);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
    }

    th {
      background: var(--primary);
      color: var(--text-light);
      font-weight: 500;
    }

    tr {
      cursor: pointer;
      transition: background 0.2s;
    }

    tr:hover {
      background: var(--secondary-light);
    }

    .assessment-details {
      display: none;
      background: var(--bg-gray);
    }

    .assessment-details td {
      padding: 10px 15px;
      font-size: 0.9rem;
      color: var(--text-dark);
    }

    .fa-chevron-down {
      transition: transform 0.3s;
    }

    tr.expanded .fa-chevron-down {
      transform: rotate(180deg);
    }

    .score {
      color: var(--success);
      font-weight: 500;
    }
  </style>
  {% load static %}
  <link rel="stylesheet" href="{% static 'faculty/css/navbar.css' %}">
</head>
<body>
{% if request.user_role == 'instructor' %}
    {% include "faculty/navbar.html" %}
{% elif request.user_role == 'student' %}
    {% include "students/academic/navbar.html" %}
{% elif request.user_role == 'executive' %}
    {% include "executives/navbar.html" %}
{% else %}
    {% include "public/navbar.html" %}
{% endif %}

<script>
function printAssessmentSheet(data, courseTitle, term, batch) {
    if (!Array.isArray(data) || data.length === 0) {
        console.error("Invalid data provided");
        return;
    }

    // Filter out null entries
    data = data.filter(student => student !== null);
    if (data.length === 0) {
        console.error("No valid students in data");
        return;
    }

    // Collect all assessment types from the first student
    const assessmentTypes = Object.keys(data[0].assessment_results);

    // Create table element
    const table = document.createElement("table");
    table.style.borderCollapse = "collapse";
    table.style.width = "100%";
    table.style.fontFamily = "Arial, sans-serif";
    table.style.marginTop = "20px";

    // Table header
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    const headers = ["No.", "Name", "YKPT", ...assessmentTypes, "Total Percent", "Signature"];
    headers.forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        th.style.border = "1px solid #000";
        th.style.padding = "6px";
        th.style.textAlign = "center";
        th.style.backgroundColor = "#f0f0f0";
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Table body
    const tbody = document.createElement("tbody");
    data.forEach((student, index) => {
        const tr = document.createElement("tr");

        // No.
        let td = document.createElement("td");
        td.textContent = index + 1;
        td.style.border = "1px solid #000";
        td.style.padding = "6px";
        td.style.textAlign = "center";
        tr.appendChild(td);

        // Name
        td = document.createElement("td");
        td.textContent = student.student_name;
        td.style.border = "1px solid #000";
        td.style.padding = "6px";
        tr.appendChild(td);

        // YKPT / Roll No
        td = document.createElement("td");
        td.textContent = student.roll_no;
        td.style.border = "1px solid #000";
        td.style.padding = "6px";
        tr.appendChild(td);

        // Assessments
        let totalPercent = 0;
        assessmentTypes.forEach(type => {
            const result = student.assessment_results[type];
            td = document.createElement("td");
            td.textContent = `${result.got_percent}/${result.given_percent}`;
            td.style.border = "1px solid #000";
            td.style.padding = "6px";
            td.style.textAlign = "center";
            tr.appendChild(td);

            totalPercent += result.got_percent;
        });

        // Total Percent
        td = document.createElement("td");
        td.textContent = totalPercent.toFixed(2);
        td.style.border = "1px solid #000";
        td.style.padding = "6px";
        td.style.textAlign = "center";
        tr.appendChild(td);

        // Signature (empty)
        td = document.createElement("td");
        td.textContent = "";
        td.style.border = "1px solid #000";
        td.style.padding = "6px";
        tr.appendChild(td);

        tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    // Create print window
    const printWindow = window.open('', '', 'width=900,height=600');
    printWindow.document.write('<html><head><title>Assessment Sheet</title></head><body style="font-family: Arial, sans-serif;">');

    // Inject your existing header HTML
    printWindow.document.write(`
        <header style="margin-top: 80px;">
          <h1><i class="fa-solid fa-clipboard-list"></i> Assessment Results for ${courseTitle}</h1>
          <div class="course-info">
            <i class="fa-solid fa-calendar"></i> Term: ${term} &nbsp; | &nbsp; 
            <i class="fa-solid fa-graduation-cap"></i> Batch: ${batch}
          </div>
        </header>
    `);

    // Add table
    printWindow.document.body.appendChild(table);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}

</script>

<header style="margin-top: 80px;">
  <h1><i class="fa-solid fa-clipboard-list"></i> Assessment Results for {{ course_title }}</h1>
  <div class="course-info">
    <i class="fa-solid fa-calendar"></i> Term: {{ term }} &nbsp; | &nbsp; 
    <i class="fa-solid fa-graduation-cap"></i> Batch: {{batch}}
  </div>
</header>

<div class="search-box">
  <input type="text" id="search" placeholder="Search students by name, roll no, phone, or email...">
  <button class="btn btn-primary" id="printMarks">Print Assessment Marks</button>
  <script>
    document.getElementById("printMarks").addEventListener("click", async () => {
        const batchInstructorId = "{{ batch_instructor_id }}";  // comes from Django template context
        const url = `/faculty/print_assessment_results/${batchInstructorId}`;

        try {
            const response = await fetch(url, {
                method: "GET",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json(); // or response.text() depending on what server returns
            console.log("Response:", data);
            printAssessmentSheet(data.results, '{{course_title}}', '{{term}}', '{{batch}}');
        } catch (error) {
            console.error("Error fetching data:", error);
            alert("Failed to fetch assessment marks.");
        }
    });
</script>
</div>
  
</div>

<table id="resultsTable">
  <thead>
    <tr>
      <th><i class="fa-solid fa-user"></i> Name</th>
      <th><i class="fa-solid fa-id-card"></i> Roll No</th>
      <th><i class="fa-solid fa-phone"></i> Phone</th>
      <th><i class="fa-solid fa-envelope"></i> Email</th>
      <th><i class="fa-solid fa-chevron-down"></i></th>
    </tr>
  </thead>
  <tbody>
    {% for student in students %}
      <tr class="student-row">
        <td>{{ student.name }}</td>
        <td>{{ student.roll_no }}</td>
        <td>{{ student.phone }}</td>
        <td>{{ student.email }}</td>
        <td><i class="fa-solid fa-chevron-down"></i></td>
      </tr>
      <tr class="assessment-details">
        <td colspan="5">
          {% for a in student.assessments %}
            <div><i class="fa-solid fa-check"></i> {{ a.title }}: 
              <span class="score">{{ a.score }}</span> out of {{ a.total }}
            </div>
          {% endfor %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.querySelectorAll(".student-row").forEach((row, idx) => {
    row.addEventListener("click", () => {
      const detailRow = row.nextElementSibling;
      const isExpanded = row.classList.contains("expanded");

      document.querySelectorAll(".student-row").forEach(r => r.classList.remove("expanded"));
      document.querySelectorAll(".assessment-details").forEach(dr => dr.style.display = "none");

      if (!isExpanded) {
        row.classList.add("expanded");
        detailRow.style.display = "table-row";
      }
    });
  });

  document.getElementById("search").addEventListener("input", function() {
    const query = this.value.toLowerCase();
    document.querySelectorAll("tbody tr.student-row").forEach(row => {
      const detailRow = row.nextElementSibling;
      const text = row.innerText.toLowerCase();
      const match = text.includes(query);
      row.style.display = match ? "" : "none";
      detailRow.style.display = "none"; // hide details when filtering
    });
  });
</script>

</body>
</html>
