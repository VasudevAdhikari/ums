{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Mailbox</title>
    <link rel="stylesheet" href="{% static 'students/mailbox/styles/mailbox.css' %}">
    <link rel="stylesheet" href="{% static 'students/mailbox/styles/comments.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .edit-lightbox {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            animation: fadeIn 0.3s;
        }
        .edit-lightbox.active {
            display: flex;
        }
        .edit-lightbox .lightbox-content {
            background: #fff;
            padding: 24px 28px;
            border-radius: 12px;
            min-width: 340px;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            animation: popupIn 0.4s cubic-bezier(.68,-0.55,.27,1.55);
        }
        #edit-selected-media-preview img, #edit-selected-media-preview video {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            margin: 4px;
            object-fit: cover;
            box-shadow: 0 2px 8px #eee;
            transition: transform 0.2s;
        }
        #edit-selected-media-preview img:hover, #edit-selected-media-preview video:hover {
            transform: scale(1.08);
        }
        #edit-lightbox-close, .close-lightbox {
            position: absolute;
            right: 16px;
            top: 10px;
            font-size: 22px;
            cursor: pointer;
            color: #888;
            transition: color 0.2s;
        }
        #edit-lightbox-close:hover, .close-lightbox:hover {
            color: #e74c3c;
        }
        .post-actions {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .user-profile:hover .post-actions {
            opacity: 1;
        }
        .edit-post-btn, .delete-post-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 6px;
            border-radius: 50%;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .edit-post-btn:enabled:hover {
            background: #eaf6ff;
            box-shadow: 0 2px 8px #b3e0ff44;
        }
        .edit-post-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .delete-post-btn:hover {
            background: #ffeaea;
            box-shadow: 0 2px 8px #ffb3b344;
        }
        .post-status-badge {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            vertical-align: middle;
            transition: background 0.3s, color 0.3s;
        }
        .status-pending { background: #f1c40f; color: #fff; }
        .status-approved { background: #2ecc40; color: #fff; }
        .status-rejected { background: #e74c3c; color: #fff; }
        .status-disqualified { background: #8e44ad; color: #fff; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes popupIn {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        #edit-selected-media-preview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 18px;
            margin-bottom: 12px;
        }
        #edit-selected-media-preview .media-thumb {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            background: #f7f7f7;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px #eee;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #edit-selected-media-preview img,
        #edit-selected-media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            display: block;
        }
        #edit-selected-media-preview .delete-media-btn {
            position: absolute;
            top: 7px;
            right: 7px;
            background: rgba(255, 60, 60, 0.92);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            transition: background 0.2s;
            box-shadow: 0 2px 8px #e74c3c33;
        }
        #edit-selected-media-preview .delete-media-btn:hover {
            background: #e74c3c;
        }
        .edit-media-actions {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .edit-add-media-btn {
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 18px;
            font-size: 15px;
            font-family: 'Poppins', sans-serif;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 7px;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px #b3e0ff44;
        }
        .edit-add-media-btn:hover {
            background: #217dbb;
        }
        #edit-post-text {
            font-family: 'Poppins', sans-serif !important;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
            padding: 8px;
            margin-bottom: 12px;
            width: 100%;
            box-sizing: border-box;
            transition: border 0.2s;
        }
        #edit-post-text:focus {
            border: 1.5px solid #3498db;
        }
        /* Match edit-post-container to write-post-container style */
        .edit-lightbox .write-post-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            padding: 18px 18px 12px 18px;
            margin: 0 auto;
            max-width: 540px;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
            animation: popupIn 0.4s cubic-bezier(.68,-0.55,.27,1.55);
        }
        .edit-lightbox .post-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .edit-lightbox .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .edit-lightbox .user-profile img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #eee;
        }
        .edit-lightbox .post-input-container {
            margin-top: 8px;
            margin-bottom: 0;
        }
        .edit-lightbox #edit-post-text {
            font-family: 'Poppins', sans-serif !important;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #eee;
            padding: 8px;
            margin-bottom: 12px;
            width: 100%;
            box-sizing: border-box;
            transition: border 0.2s;
            background: #f9f9f9;
            resize: vertical;
        }
        .edit-lightbox #edit-post-text:focus {
            border: 1.5px solid #3498db;
            background: #fff;
        }
        .edit-lightbox .selected-media-preview {
            margin-bottom: 10px;
        }
        .edit-lightbox .edit-media-actions {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .edit-lightbox .edit-add-media-btn {
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 18px;
            font-size: 15px;
            font-family: 'Poppins', sans-serif;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 7px;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px #b3e0ff44;
        }
        .edit-lightbox .edit-add-media-btn:hover {
            background: #217dbb;
        }
        .edit-lightbox .post-buttons {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        .edit-lightbox .post-submit-btn {
            background: #2ecc40;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 22px;
            font-size: 15px;
            font-family: 'Poppins', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .edit-lightbox .post-submit-btn:hover {
            background: #27ae60;
        }
        .edit-lightbox .post-cancel-btn {
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 22px;
            font-size: 15px;
            font-family: 'Poppins', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .edit-lightbox .post-cancel-btn:hover {
            background: #c0392b;
        }
        .edit-lightbox #edit-selected-media-preview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 18px;
            margin-bottom: 12px;
        }
        .edit-lightbox #edit-selected-media-preview .media-thumb {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            background: #f7f7f7;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px #eee;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .edit-lightbox #edit-selected-media-preview img,
        .edit-lightbox #edit-selected-media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            display: block;
        }
        .edit-lightbox #edit-selected-media-preview .delete-media-btn {
            position: absolute;
            top: 7px;
            right: 7px;
            background: rgba(255, 60, 60, 0.92);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            transition: background 0.2s;
            box-shadow: 0 2px 8px #e74c3c33;
        }
        .edit-lightbox #edit-selected-media-preview .delete-media-btn:hover {
            background: #e74c3c;
        }
        /* Match edit-media-preview to selected-media-preview from write-post-container */
        .edit-lightbox #edit-selected-media-preview,
        .edit-lightbox .selected-media-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
            padding: 0;
        }
        .edit-lightbox #edit-selected-media-preview .media-thumb,
        .edit-lightbox .selected-media-preview .media-thumb {
            position: relative;
            width: 90px;
            height: 90px;
            background: #f7f7f7;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px #eee;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .edit-lightbox #edit-selected-media-preview img,
        .edit-lightbox #edit-selected-media-preview video,
        .edit-lightbox .selected-media-preview img,
        .edit-lightbox .selected-media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            display: block;
        }
        .edit-lightbox #edit-selected-media-preview .delete-media-btn,
        .edit-lightbox .selected-media-preview .delete-media-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(255, 60, 60, 0.92);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            transition: background 0.2s;
            box-shadow: 0 2px 8px #e74c3c33;
        }
        .edit-lightbox #edit-selected-media-preview .delete-media-btn:hover,
        .edit-lightbox .selected-media-preview .delete-media-btn:hover {
            background: #e74c3c;
        }
        /* ...existing code... */
    </style>
    <!-- Add CSRF Token -->
    <script>
        const csrftoken = '{{ csrf_token }}';
        const current_page = '{{ current_page }}';
        console.log(current_page);
    </script>
</head>

<body>
    <div class="mailbox-banner">
        <img src="{% static 'students/mailbox/images/feed-image-1.png' %}" alt="Mailbox Banner">
        <div class="banner-overlay">
            <h1>Student Mailbox</h1>
        </div>
    </div>
    <br>


    <!-- Description Section -->
    <div class="mailbox-description">
        <p class="description-text">
            Welcome to the Student Mailbox - your central hub for academic discussions, resource sharing, and community
            engagement. Connect with fellow students, share your thoughts, and stay updated with the latest campus
            activities. This platform is designed to foster meaningful interactions and collaborative learning among
            students.
            <span class="more-text" style="display: none;">
                Whether you're looking to discuss course materials, organize study groups, or simply connect with peers,
                the Student Mailbox provides a safe and inclusive space for all academic-related conversations. Join our
                growing community and be part of an enriching educational experience.
            </span>
        </p>
        <button class="show-more-btn" type="button">Show More</button>
    </div>
    <div class="manage-post-container" onclick="window.location.href='/students/mailbox/'">
        <span class="manage-title">Back to Mailbox </span>
        <span class="manage-item">
            <i class="fa-solid fa-file-lines"></i>
            <span>Your Posts</span>
            <span class="manage-count manage-count-posts">{{ post_count|default:0 }}</span>
        </span>
        <span class="manage-item">
            <i class="fa-solid fa-hourglass-half"></i>
            <span>Pending Posts</span>
            <span class="manage-count manage-count-pending">{{ pending_count|default:0 }}</span>
        </span>
        <span class="manage-item">
            <i class="fa-solid fa-bell"></i>
            <span>Notifications</span>
            <span class="manage-count manage-count-notification">{{ notification_count|default:0 }}</span>
        </span>
    </div>
    <br>
    <div class="container">

        <div class="main-content" id="manage-posts-list">
            <!-- Posts will be loaded here dynamically by JS -->
            <div id="loading-indicator" style="text-align:center; display:none;">
                <span>Loading...</span>
            </div>
            <div id="no-more-posts" style="text-align:center; display:none;">
                <span>No more posts to show.</span>
            </div>
        </div>
    </div>

    <!-- Reaction Lightbox -->
    <div id="reaction-lightbox" class="reaction-lightbox" style="display:none;">
        <div class="reaction-lightbox-content">
            <span class="reaction-lightbox-close" style="cursor:pointer;float:right;font-size:2em;">&times;</span>
            <h2>All Reactions</h2>
            <div class="reaction-list"></div>
        </div>
    </div>

    <div class="copyright-footer">
        <p>Copyright 2021 MM Logic Gallery Youtube Channel</p>
    </div>
    <div id="image-lightbox" class="image-lightbox" style="display:none;">
        <span class="lightbox-close">&times;</span>
        <div class="lightbox-content">
            <img class="lightbox-img" src="" alt="Gallery Image" style="display: none;">
            <video class="lightbox-video" controls style="display: none;">
                <source src="" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>
        <span class="lightbox-prev">&#10094;</span>
        <span class="lightbox-next">&#10095;</span>
        <div class="lightbox-counter"></div>
    </div>

    <div class="edit-lightbox" id="edit-lightbox" style="display:none;">
        <div class="lightbox-content">
            <form id="edit-post-form">
                <div class="write-post-container">
                    <div class="post-row">
                        <div class="user-profile">
                            <img src="{{ requester.user.profile_picture.url }}" alt="profile-pic">
                            <div>
                                <p>{{requester.user.full_name}}</p>
                                <small>Edit Your Post<i class="fas fa-caret-down"></i></small>
                            </div>
                        </div>
                        <a href="#" class="close-lightbox" id="edit-lightbox-close"><i class="fas fa-times"></i></a>
                    </div>
                    <div class="post-input-container">
                        <textarea rows="3" id="edit-post-text"
                            placeholder="Edit your post..."></textarea>
                        <div class="selected-media-preview" id="edit-selected-media-preview"></div>
                        <div class="edit-media-actions">
                            <button type="button" id="edit-add-media-btn" class="edit-add-media-btn">
                                <i class="fa fa-plus"></i> Add Media
                            </button>
                            <input type="file" id="edit-media-input" accept="image/*,video/*" multiple style="display:none;">
                        </div>
                        <div class="post-buttons" style="display: flex;">
                            <button type="submit" id="edit-submit-btn" class="post-submit-btn">Save Changes</button>
                            <button type="button" class="post-cancel-btn" id="edit-cancel-btn">Cancel</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Add static URLs as JavaScript variables
        const STATIC_URLS = {
            likeImage: "{% static 'students/mailbox/images/like.png' %}",
            commentsImage: "{% static 'students/mailbox/images/comments.png' %}",
            shareImage: "{% static 'students/mailbox/images/share.png' %}"
        };

        // Show More/Less logic for mailbox description
        document.addEventListener('DOMContentLoaded', function () {
            var showMoreBtn = document.querySelector('.show-more-btn');
            var moreText = document.querySelector('.more-text');
            if (showMoreBtn && moreText) {
                showMoreBtn.addEventListener('click', function () {
                    if (moreText.style.display === 'none' || moreText.style.display === '') {
                        moreText.style.display = 'inline';
                        showMoreBtn.textContent = 'Show Less';
                    } else {
                        moreText.style.display = 'none';
                        showMoreBtn.textContent = 'Show More';
                    }
                });
            }
        });

        // Edit-lightbox JS
        function openEditLightbox(post) {
            const lightbox = document.getElementById('edit-lightbox');
            const textArea = document.getElementById('edit-post-text');
            const preview = document.getElementById('edit-selected-media-preview');
            textArea.value = post.post.post_text;
            preview.innerHTML = '';
            (post.post.post_files || []).forEach(file => {
                const isVideo = /\.(mp4|mkv|avi|mov)$/i.test(file);
                if (isVideo) {
                    preview.innerHTML += `<video src="/media/${file}" controls></video>`;
                } else {
                    preview.innerHTML += `<img src="/media/${file}" />`;
                }
            });
            lightbox.style.display = 'flex';
            lightbox.classList.add('active');
            lightbox.dataset.postId = post.id || post.post.id || post.post_id;
        }
        document.getElementById('edit-cancel-btn').onclick = function(e) {
            e.preventDefault();
            const lightbox = document.getElementById('edit-lightbox');
            lightbox.style.display = 'none';
            lightbox.classList.remove('active');
        };
        document.getElementById('edit-lightbox-close').onclick = function(e) {
            e.preventDefault();
            const lightbox = document.getElementById('edit-lightbox');
            lightbox.style.display = 'none';
            lightbox.classList.remove('active');
        };
        document.getElementById('edit-photo-input').addEventListener('change', function() {
            updateEditMediaPreview();
        });
        document.getElementById('edit-video-input').addEventListener('change', function() {
            updateEditMediaPreview();
        });
        function updateEditMediaPreview() {
            const preview = document.getElementById('edit-selected-media-preview');
            preview.innerHTML = '';
            const photoFiles = document.getElementById('edit-photo-input').files;
            const videoFiles = document.getElementById('edit-video-input').files;
            for (let file of photoFiles) {
                const url = URL.createObjectURL(file);
                preview.innerHTML += `<img src="${url}" />`;
            }
            for (let file of videoFiles) {
                const url = URL.createObjectURL(file);
                preview.innerHTML += `<video src="${url}" controls></video>`;
            }
        }
        document.getElementById('edit-post-form').onsubmit = function(e) {
            e.preventDefault();
            const lightbox = document.getElementById('edit-lightbox');
            const postId = lightbox.dataset.postId;
            const text = document.getElementById('edit-post-text').value.trim();
            const photoFiles = document.getElementById('edit-photo-input').files;
            const videoFiles = document.getElementById('edit-video-input').files;
            const formData = new FormData();
            formData.append('post_id', postId);
            formData.append('text', text);
            for (let file of photoFiles) formData.append('media', file);
            for (let file of videoFiles) formData.append('media', file);
            fetch('/students/mailbox/edit_post/', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                body: formData
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    lightbox.style.display = 'none';
                    lightbox.classList.remove('active');
                    window.location.reload();
                } else {
                    alert('Failed to update post.');
                }
            });
        };

        // --- Fix: Attach event delegation for edit buttons after posts are rendered ---
        document.addEventListener('click', function(e) {
            // Use event delegation for dynamically loaded posts
            if (e.target.closest('.edit-post-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.edit-post-btn');
                // Get post data from the DOM or fetch it as needed
                const postId = btn.getAttribute('data-post-id');
                // You must have a way to get the post data by ID, e.g. from a JS variable or fetch
                // For demonstration, let's assume you have a global postsById object:
                if (window.postsById && window.postsById[postId]) {
                    openEditLightbox(window.postsById[postId]);
                } else if (typeof getPostDataById === 'function') {
                    // If you have a function to fetch post data
                    getPostDataById(postId).then(post => openEditLightbox(post));
                } else {
                    alert('Cannot find post data for editing.');
                }
            }
        });
    </script>
    <script src="{% static 'students/mailbox/javascripts/mailbox2.js' %}"></script>
    <script src="{% static 'students/mailbox/javascripts/comments.js' %}"></script>
</body>

</html>